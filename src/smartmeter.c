// Include used libraries
#include "smartmeter.h"					// Smartmeter header

// Global variable

SmartMeter sm_data;                     // Store smart meter main variables data;    
IpDFT ip_dft_data;                      // Store IpDFT algorithm return values

static void adc_i2s_init(void)
{

    static const i2s_config_t i2s_config = {
        .mode = I2S_MODE_MASTER | I2S_MODE_RX | I2S_MODE_ADC_BUILT_IN,
        .sample_rate = ADC_SAMPLE_RATE*2,
        .bits_per_sample = I2S_BITS_PER_SAMPLE_16BIT,
        .communication_format = I2S_COMM_FORMAT_I2S_MSB,
        .channel_format = I2S_CHANNEL_FMT_ONLY_LEFT,
        .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
        .dma_buf_count = ADC_DMA_COUNT,
        .dma_buf_len = ADC_BUFFER_SIZE,
        .use_apll = false,
    };
    //install and start i2s driver
    i2s_driver_install(I2S_NUM, &i2s_config, 0, NULL);
    // ADC-I2S Scanning does not normal start (more badly) after the reset of ESP32. 
    // It is necessary to add a delay of 5 seconds before switching on the ADC for a reliable start, this is issue.
    vTaskDelay(5000/portTICK_RATE_MS);
    //init ADC pad
    static const adc_i2s_pattern_t adc_i2s_pattern[] = {
        {
            .atten = ADC_ATTEN_DB_11,
            .bits = ADC_WIDTH_BIT_12,
            .channel = ADC1_CHANNEL_0,
        },
        {
            .atten = ADC_ATTEN_DB_11,
            .bits = ADC_WIDTH_BIT_12,
            .channel = ADC1_CHANNEL_3
        }
    };

    i2s_set_adc_mode(ADC_UNIT_1, adc_i2s_pattern, sizeof(adc_i2s_pattern));

}
// # ----------------------------------------------
// # SIGNAL GENERATOR 
// # ----------------------------------------------


void signal_generator_task(void *parameters)
{
    static uint8_t table_sin_wave[SIN_WAVE_NUM] = {
    // Sin wave
        128,131,134,137,141,144,147,150,153,156,159,162,165,168,171,174,
        177,180,183,186,188,191,194,196,199,202,204,207,209,212,214,216,218,221,223,225,227,229,231,233,234,236,
        238,239,241,242,243,245,246,247,248,249,250,251,252,253,253,254,254,255,255,255,255,255,255,
        255,255,255,255,254,254,253,253,252,251,251,250,249,248,247,245,244,243,241,240,238,
        237,235,233,232,230,228,226,224,222,220,217,215,213,210,208,205,203,200,198,195,192,190,187,184,181,178,176,
        173,170,167,164,161,158,155,151,148,145,142,139,136,133,130,126,123,120,117,114,111,108,105,101,
        98,95,92,89,86,83,80,78,75,72,69,66,64,61,58,56,53,51,48,46,43,41,39,36,34,32,30,28,26,24,23,21,
        19,18,16,15,13,12,11,9,8,7,6,5,5,4,3,3,2,2,1,1,1,1,1,1,1,1,1,1,2,2,3,3,4,5,6,7,8,9,10,
        11,13,14,15,17,18,20,22,23,25,27,29,31,33,35,38,40,42,44,47,49,52,54,
        57,60,62,65,68,70,73,76,79,82,85,88,91,94,97,100,103,106,109,112,115,119,122,125
    };

    uint16_t i = 0;
    // Enable DAC CHANNEL 1 - GPIO25
    dac_output_enable(DAC_CHANNEL_1);
    int64_t start_time = 0;
    while (true){

        // To not hog the CPU
        if( (esp_timer_get_time() - start_time >= 60) || start_time == 0){   // Check delta in uS
            dac_output_voltage(DAC_CHANNEL_1, table_sin_wave[i]);
            i++;
            if (i >= SIN_WAVE_NUM) i = 0;

            start_time = esp_timer_get_time();
        }
        // Feed watchdog
        TIMERG0.wdt_wprotect=TIMG_WDT_WKEY_VALUE;
        TIMERG0.wdt_feed=1;
        TIMERG0.wdt_wprotect=0;

    }
}

uint8_t do_thd(){
    // Compute the following parameters from harmonic = 2 ... 7;
    // - Frequency
    // - Amplitude
    // - Phase

    u16_t i = 0;
    // Config to compute applying Hanning Window and complete Goertzel calculus;
    u8_t gtz_config = 0x3;        
    
    
    float delta_phi = 0;
    float main_active_power = 0;
    float main_cosphi = 0;

    float harm_active_power = 0;
    float aux_thd_i_v  =   0;           // Store Sqrt(1 - THD_v^2)*Sqrt(1 - THD_i^2)
    // {amp, freq, phase, rms}
    float v_harm_data[7][4] = {
		{sm_data.voltage_amp, sm_data.voltage_freq, sm_data.voltage_phase}, // Main 
		{0, 0, 0, 0},          // 2nd order                 
		{0, 0, 0, 0},          // 3rd order
		{0, 0, 0, 0},          // 4th order
    	{0, 0, 0, 0},          // 5th order
    	{0, 0, 0, 0},          // 6th order
    	{0, 0, 0, 0},          // 7th order
    };
    float i_harm_data[7][4] = {
		{sm_data.current_amp, sm_data.current_freq, sm_data.current_phase}, // Main 
		{0, 0, 0, 0},          // 2nd order
		{0, 0, 0, 0},          // 3rd order
		{0, 0, 0, 0},          // 4th order
    	{0, 0, 0, 0},          // 5th order
    	{0, 0, 0, 0},          // 6th order
    	{0, 0, 0, 0},          // 7th order
    };
    // # Compute voltage and current RMS considering a pure sine wave
    float v_main_rms = (float) (v_harm_data[0][H_AMP] / M_SQRT2);
    float i_main_rms = (float) (i_harm_data[0][H_AMP] / M_SQRT2);

    // # Compute values for the main frequency
    delta_phi = (float) (v_harm_data[0][H_PHASE] - i_harm_data[0][H_PHASE]);
    main_cosphi = cosf(delta_phi);

    sm_data.active_power   = (float) (v_main_rms * i_main_rms * main_cosphi);
    main_active_power = sm_data.active_power;  // used to compute Pn/P1

    sm_data.reactive_power = (float) (v_main_rms * i_main_rms * sinf(delta_phi));

    sm_data.THD_V = 0;
    sm_data.THD_I = 0;

    //printf("\n Debug delta_phi=%f, main_cosphi=%f, v_main_rms=%f, i_main_rms=%f, main_active_power=%f, sm_data.reactive_power=%f\n", delta_phi, main_cosphi, v_main_rms, i_main_rms,main_active_power, sm_data.reactive_power);

    // # Compute harmonics amplitude and phase using Goertzel.
    // Start from i=1 because first position stores main signal values.
    for (i = 1; i < ARRAY_LEN(v_harm_data) - 1; i++){
        // # Compute harmonic frequency
        v_harm_data[i][H_FREQ] = (float) (v_harm_data[0][H_FREQ] * i);
        i_harm_data[i][H_FREQ] = (float) (i_harm_data[0][H_FREQ] * i);

        // # Apply goertzel to current and voltage harmonic frequency
        goertzel_handle = goertzel(&buf_voltage, &g_state, v_harm_data[i][H_FREQ], ADC_SAMPLE_RATE, gtz_config);
        v_harm_data[i][H_AMP] = 1 * g_state.DFT_m;      // # Store Goertzel magnitude
        v_harm_data[i][H_PHASE] = g_state.DFT_arg;      // # Store Goertzel angle

        goertzel_handle = goertzel(&buf_current, &g_state, i_harm_data[i][H_FREQ], ADC_SAMPLE_RATE, gtz_config);
        i_harm_data[i][H_AMP] = 1 * g_state.DFT_m;      // # Store Goertzel magnitude
        i_harm_data[i][H_PHASE] = g_state.DFT_arg;      // # Store Goertzel angle

        // Compute harmonic RMS value
        v_harm_data[i][H_RMS] = (float) (v_harm_data[i][H_AMP] / M_SQRT2);
        i_harm_data[i][H_RMS] = (float) (i_harm_data[i][H_AMP] / M_SQRT2);

        // # Compute active and reactive power for the current harmonic
        delta_phi = (float) (v_harm_data[0][H_PHASE] - i_harm_data[0][H_PHASE]);    // Use aux to compute delta phi
        harm_active_power = (float) (v_harm_data[i][H_RMS] * i_harm_data[i][H_RMS]);// Used as aux to compute V*I
        sm_data.reactive_power += (float) (harm_active_power * sinf(delta_phi));    // Sum harmonic piece into total active power 

        harm_active_power *= cosf(delta_phi);                                       // Multiply by cos(phi), now it is active power 
        sm_data.active_power += harm_active_power;                                  // Sum harmonic piece into total active power 
        

        // Compute sum of (Vrms_n / Vrms_1) and (Irms_n / Irms_1)
        sm_data.THD_V += (float) (v_harm_data[i][H_RMS] / v_main_rms);
        sm_data.THD_I += (float) (i_harm_data[i][H_RMS] / i_main_rms);
        sm_data.THD_P += (float) (harm_active_power / main_active_power);
         


        // Compute 
        // Compute active and reactive power (P and Q)
    }



    // # Compute THD_v and THD_i
    sm_data.THD_V = fast_sqrt(sm_data.THD_V);
    sm_data.THD_I = fast_sqrt(sm_data.THD_I);

    // # Compute Sqrt(1 - THD_v^2)*Sqrt(1 - THD_i^2) 
    aux_thd_i_v  = (float) (fast_sqrt(1+sm_data.THD_V * sm_data.THD_V));
    aux_thd_i_v *= (float) (fast_sqrt(1+sm_data.THD_I * sm_data.THD_I));
    
    // # Compute aparent power
    sm_data.aparent_power  = (float) (v_main_rms * i_main_rms * aux_thd_i_v);

    // # Compute FP
    sm_data.fp  = (float) (main_cosphi * (1 + sm_data.THD_P));
    sm_data.fp /= (float) (aux_thd_i_v);

    sm_data.frequency = (sm_data.voltage_freq + sm_data.current_freq) / 2;

    //show_sm_values();
    return 1;
}
void show_sm_values(){
    printf("\n===========[ Smart Meter values ]===========\n ");
    printf(" - v_rms           = %f\n", sm_data.v_rms);
    printf(" - i_rms           = %f\n", sm_data.i_rms);         
    printf(" - aparent_power   = %f\n", sm_data.aparent_power);
    printf(" - active_power    = %f\n", sm_data.active_power);
    printf(" - reactive_power  = %f\n", sm_data.reactive_power);
    printf(" - frequency       = %f\n", sm_data.frequency);
    printf(" - voltage_amp     = %f\n", sm_data.voltage_amp);   
    printf(" - voltage_freq    = %f\n", sm_data.voltage_freq); 
    printf(" - voltage_phase   = %f\n", sm_data.voltage_phase);
    printf(" - current_amp     = %f\n", sm_data.current_amp);
    printf(" - current_phase   = %f\n", sm_data.current_phase); 
    printf(" - current_freq    = %f\n", sm_data.current_freq);
    printf(" - fp              = %f\n", sm_data.fp);
    printf(" - THD_V           = %f\n", sm_data.THD_V);         
    printf(" - THD_I           = %f\n", sm_data.THD_I);       
    printf(" - THD_P           = %f\n", sm_data.THD_P);
    printf("============================================\n");      
}
uint8_t do_ipdft(Buffer *buf, IpDFT *ipdft){


    u16_t i = 0;
    u8_t epsilon;   
    float delta, delta_pi;

    // Frequecies and amplitudes around 60 Hz where Goertzel algorithm will be applied.
	float dft[5][3] = {      
		{0, 50, 0},                        // {amp, freq, phase}           
		{0, 55, 0},                        // {amp, freq, phase}
		{0, 60, 0},                        // {amp, freq, phase}
		{0, 65, 0},                        // {amp, freq, phase}
    	{0, 70, 0},                        // {amp, freq, phase}
	};

    // Config to compute applying Hanning Window and complete Goertzel calculus;
    u8_t gtz_config = 0x3;           

    // Compute goertzel for frequencies arround main frequency
    for (i = 0; i < G_MAIN_FREQ_NUM; i++){
        // # Apply Goertzel to current frequency
        goertzel_handle = goertzel(buf, &g_state, dft[i][1], ADC_SAMPLE_RATE, gtz_config);
        
        dft[i][0] = 1 * g_state.DFT_m;  // # Store Goertzel magnitude
        dft[i][2] = g_state.DFT_arg;    // # Store Goertzel angle
        //printf("%f, %f\n", dft[i][0], dft[i][1]);
    }
    

    // ## Interpolation ##
    u8_t k = 0;         // Index from the highest amplitude found using Goertzel algo
    u16_t k_m = 0;       // Index of DFT
    // # Find highest amplitude in DFT vector:
    for (i = 1; i < G_MAIN_FREQ_NUM-1; i++){
        if(dft[i][0] > dft[i-1][0] && dft[i][0] > dft[i+1][0]){
            k = i;
        }
    }
    
    // # Compute IpDFT algorithm for Hanning Window
    if(k > 0){
        epsilon = (dft[k+1][0] >= dft[k-1][0]) ? 1 : -1;
        //delta = epsilon * (2 * dft[k+epsilon][0] - dft[k][0]) / (dft[k][0] + dft[k+epsilon][0]);
        delta =  (float) (dft[k + epsilon][0] - dft[k - epsilon][0]);
        delta /= (float) (dft[k - epsilon][0] + 2* dft[k][0] + dft[k + epsilon][0]);
        delta *= (float) (2 * epsilon);
        // # Delta deve estar entre 0.5 <= δ < 0.5 
        if(delta >= 0.5) delta = 0.5;
        if(delta < -0.5) delta = -0.5;
        // # Compute k_m index
        k_m = (u16_t) floor((0.5 + (buf->size * dft[k][1] / ADC_SAMPLE_RATE)));
        // # Interpolate to get main frequency
        ipdft->frequency = (k_m + delta)* (1 / SAMPLING_WINDOW_TIME);

        // # Compute real signal amplitude
        delta_pi = M_PI * delta;
        ipdft->amplitude = fabs (dft[k][0]);
        ipdft->amplitude *= fabs ( (float) (delta_pi) / (float) sinf(delta_pi));
        ipdft->amplitude *= fabs ( (float) (delta*delta - 1));

        // # Compute signal phase
        ipdft->phase_ang = dft[k][2] - delta_pi;

        // Debug
        //printf("\nMaior amplitude = %f, k = %d\n", dft[k][0], k);
        //printf("- Epsilon: %d \n", epsilon);
        //printf("- delta: %f \n", delta);
        //printf("- k_m: %d \n", k_m);
        //printf("- delta_pi: %f \n", delta_pi);
        //printf("- Main frequency: %f\n", ipdft->frequency);
        //printf("- Main amplitude: %f\n", ipdft->amplitude);
        //printf("- Phase angle: %f\n", ipdft->phase_ang);
        return 1;
    } else {
        return 0;
    }
    

}
// Compute rms and remove dc offset
void do_rms(Buffer *voltage, Buffer *current){
    u32_t sum_voltage = 0;
    u32_t sum_current = 0;
    //printf("\n - Max value: %u", voltage->max);
    //printf("\n - Min value: %u\n", voltage->min);
    // # Calcula o valor de offset do sinal
    u16_t voltage_offset = (voltage->max + voltage->min) / 2;
    u16_t current_offset = (current->max + current->min) / 2;
    
    // Remove o offset do sinal e computa o somatório da sua potência
    for (u16_t i = 0; i < BUFFER_SIZE; i++){
        // Atualiza o valor do buffer removendo o offset
        voltage->data[i] -= voltage_offset;
        current->data[i] -= current_offset;
        // Remove o offset do valor de tensão e atualiza no buffer
        sum_voltage += (uint32_t) (voltage->data[i]*voltage->data[i]);
        sum_current += (uint32_t) (current->data[i]*current->data[i]);
    }
    // Cálculo do RMS
    sm_data.v_rms = fast_sqrt(sum_voltage / BUFFER_SIZE);
    sm_data.i_rms = fast_sqrt(sum_current / BUFFER_SIZE);

    // # Debug
    //printf("==================\n");
    //printf("v_rms = %f\n", sm_data.v_rms );
    //printf("i_rms = %f\n", sm_data.i_rms );
    //printf("voltage_offset = %d\n", voltage_offset );
    //printf("current_offset = %d\n", current_offset );
    //printf("==================\n");
}


// # Verify buffers state
bool buffers_verify(){
    return (buf_voltage.size >= BUFFER_SIZE || buf_current.size >= BUFFER_SIZE || buffer_handle == -1) ? true : false;
}


/*
    Apply linear equation to convert binary to mV
    y = 0.8165x + 143.21
*/ 
uint16_t convert_to_voltage(uint16_t value){
    return (float) (value * 0.8165 + 143.21);
}

void sample_read_task(void *parameters)
{
    // # Define ADC Characteristics for convertion
    esp_adc_cal_characteristics_t cal;
    esp_adc_cal_characterize(ADC_UNIT_1, ADC_ATTEN_DB_11, ADC_WIDTH_BIT_12, ADC_V_REF, &cal);

    // # Struct to moving average
    FilterTypeDef filterStruct;
    Moving_Average_Init(&filterStruct);



    // # Declare I2S variables
    adc_sample_t buf[ADC_BUFFER_SIZE];  // Raw buffer with measures from ADC;  
    size_t measures_read;               // Receive number of measures read from I2S - ADC
    
    // # Declare local variables
    u16_t sample = 0;                   // Generic variable to momently store sample value converted to mV
    u16_t loop_ctrl = 0;                // Used to control while loop

    // # Start ADC I2S Setup
    ESP_LOGI(TAG_SM, "# Starting ADC configuration");
    adc_i2s_init();
    ESP_LOGI(TAG_SM, "# ADC setup successfuly");
    buffer_clean(&buf_current);
    buffer_clean(&buf_voltage);
    ESP_LOGI(TAG_SM, "# Buffers cleaned");

    while (loop_ctrl == 0) {
        // # Read data from i2s.      
        esp_err_t err = i2s_read(I2S_NUM, buf, sizeof(buf), &measures_read, portMAX_DELAY);

        if (err != ESP_OK)
        {
            printf("i2s_read: %d\n", err);

        }
        // # Compute vector size
        measures_read /= sizeof(adc_sample_t);  

        // # Loop on measures to convert and save on buffer
        for (u16_t i = 0; i < measures_read; i ++)
        {
            // Get channels offset on buffer
            switch (buf[i] >> 12){
                case ADC_CURRENT_CHANNEL:
                    // Realiza a conversão da amostra para tensão de acordo com calibração
                    sample = convert_to_voltage(ADC_GET_MEASURE(buf[i]));
                    sample = Moving_Average_Compute(sample, &filterStruct);
                    // Salva no buffer de tensão
                    buffer_handle = buffer_push(&buf_current, sample);
                    break;
                case ADC_VOLTAGE_CHANNEL:
                    // Realiza a conversão da amostra para tensão de acordo com calibração
                    sample = convert_to_voltage(ADC_GET_MEASURE(buf[i]));
                    sample = Moving_Average_Compute(sample, &filterStruct);
                    // Salva no buffer de tensão
                    buffer_handle = buffer_push(&buf_voltage, sample);
                    break; 
                default:
                    ESP_LOGE(TAG_SM, "# Unknown channel %d", buf[0]>>12);

            }
        }
        if(buf_voltage.size != buf_current.size){
            ESP_LOGE(TAG_SM, "# Voltage buffer and current doesn't have the same size [%d/%d]", buf_voltage.size, buf_current.size);
        } else {

            // Verifica se os buffers chegaram ao limite
            if(buffers_verify()){
                // Debug
                int64_t start_time = 0;             // Start time tick [us]
                int64_t end_time = 0;               // End time tick [us]
                float time_spent = 0;	            // Time spent in the execution [s]
                start_time = esp_timer_get_time();      // Debug
                // # Compute RMS and remove DC offset from signals;
                /*for(uint16_t x = 0; x < buf_voltage.size ; x++){
                    printf("%u,%d;", x, buf_voltage.data[x]);
                }*/
                do_rms(&buf_voltage, &buf_current);
                // # Apply goertzel to voltage signal
                //ESP_LOGI(TAG_SM, "- Executing IPDFT for voltage");
                ipdft_handle = do_ipdft(&buf_voltage, &ip_dft_data);
                if(ipdft_handle != 0){
                    // # Store result into main data block
                    sm_data.voltage_amp = ip_dft_data.amplitude;
                    sm_data.voltage_phase = ip_dft_data.phase_ang;
                    sm_data.voltage_freq = ip_dft_data.frequency;
                    //ESP_LOGI(TAG_SM, "- Executing IPDFT for current");
                    // # Apply goertzel to current signal
                    ipdft_handle = do_ipdft(&buf_current, &ip_dft_data);
                    if(ipdft_handle != 0){
                        // # Store result into main data block
                        sm_data.current_amp = ip_dft_data.amplitude;
                        sm_data.current_phase = ip_dft_data.phase_ang;
                        sm_data.current_freq = ip_dft_data.frequency;

                        //ESP_LOGI(TAG_SM, "- Executing THD and general calculations");
                        do_thd();

                    } else {
                        ESP_LOGE(TAG_SM, "# Error when computing IpDFT for current");
                    }
                } else {
                    ESP_LOGE(TAG_SM, "# Error when computing IpDFT for voltage");
                }

                buffer_clean(&buf_current);
                buffer_clean(&buf_voltage);
                // # Debug 
                // Obtain current time
                end_time = esp_timer_get_time();

                // Calculating time spent
                time_spent = (float)(end_time - start_time) / 1000;
                printf("smart meter execution time = %f ms\n", time_spent);
                //loop_ctrl = 1;
            }
        }
            

    }
    // Debug
    /*
    int s = 0;
    s = socket_tcp_connect();
    if(s >= 0){
        uint8_t* tcp_buffer;
        tcp_buffer = (uint8_t*) calloc(8192, sizeof(uint8_t)); 

        for(uint16_t x = 0; x < buf_voltage.size ; x++){
            if(x % 2 == 0){
                tcp_buffer[x] = buf_voltage.data[x] & 0xFF;
            } else { 
                tcp_buffer[x] = buf_voltage.data[x] >> 8; 
            }

            //printf("Buffer [%d] - %d (%d)\n", x, tcp_buffer[x], buf_voltage.data[x]);
        }
            //printf("Buffer [%d] = %d\n", x, buf_voltage.data[x]);
        socket_tcp_send_data(s, tcp_buffer, 8192);
        free(tcp_buffer); 
        vTaskDelay(10 / portTICK_PERIOD_MS);
        
    }
    socket_tcp_close_connection(s);
    */

    i2s_adc_disable(I2S_NUM);
    i2s_stop(I2S_NUM);
    vTaskDelete(NULL);
    
}
void test_functions(void *parameters) {
    adc_sample_t buf[2048*2] = {2821,2890,2952,3007,3056,3098,3134,3166,3194,3220,3245,3269,3295,3321,3350,3381,3414,3450,3487,3525,3564,3602,3638,3671,3701,3727,3747,3762,3770,3773,3770,3761,3747,3729,3707,3682,3655,3626,3596,3566,3536,3505,3475,3445,3414,3383,3351,3317,3282,3244,3204,3161,3116,3068,3018,2966,2912,2858,2803,2749,2695,2641,2589,2537,2487,2437,2387,2338,2287,2235,2180,2123,2062,1997,1928,1855,1778,1697,1613,1526,1438,1350,1261,1174,1090,1009,933,861,795,735,680,630,586,546,510,477,447,419,391,364,337,309,282,253,225,197,169,142,117,93,73,55,41,30,23,19,19,23,30,39,51,66,82,99,119,139,162,185,211,238,267,298,331,367,406,447,490,536,583,632,682,733,784,835,887,938,989,1040,1091,1143,1196,1251,1308,1368,1432,1500,1573,1650,1732,1818,1909,2003,2099,2197,2296,2393,2488,2580,2668,2749,2825,2894,2955,3010,3058,3100,3136,3168,3196,3222,3246,3271,3296,3323,3351,3382,3416,3451,3489,3527,3566,3603,3640,3673,3703,3728,3748,3762,3771,3773,3770,3761,3746,3728,3706,3681,3653,3624,3595,3564,3534,3504,3474,3443,3413,3382,3349,3315,3280,3242,3202,3159,3113,3065,3015,2963,2910,2855,2801,2746,2692,2639,2586,2535,2484,2435,2385,2335,2284,2232,2177,2120,2059,1994,1925,1851,1774,1693,1609,1522,1434,1345,1257,1170,1086,1005,929,858,792,732,677,628,584,544,508,476,446,417,390,363,335,308,280,252,223,195,167,141,115,92,72,54,40,29,22,19,20,23,30,40,52,66,83,100,120,141,163,186,212,239,268,299,333,369,408,449,492,538,585,634,684,735,787,838,889,940,991,1042,1093,1145,1198,1253,1311,1371,1435,1503,1576,1654,1736,1823,1914,2008,2104,2202,2301,2398,2493,2585,2672,2753,2829,2897,2958,3013,3060,3102,3138,3169,3197,3223,3247,3272,3297,3324,3353,3384,3418,3453,3491,3529,3568,3605,3641,3675,3704,3729,3749,3763,3771,3773,3769,3760,3746,3727,3704,3679,3652,3623,3593,3563,3533,3502,3472,3442,3411,3380,3348,3314,3278,3240,3200,3156,3111,3063,3013,2960,2907,2853,2798,2743,2689,2636,2584,2532,2482,2432,2383,2333,2282,2229,2174,2117,2056,1990,1921,1848,1770,1689,1604,1518,1429,1341,1252,1166,1082,1001,925,854,789,729,674,626,582,542,507,474,444,416,388,361,334,307,279,250,222,194,166,139,114,91,71,53,39,29,22,19,20,24,31,40,53,67,83,101,121,142,164,188,213,240,270,301,335,371,410,451,495,540,588,637,687,738,789,841,892,943,994,1045,1096,1148,1201,1256,1314,1374,1439,1507,1580,1658,1740,1827,1918,2012,2109,2207,2306,2403,2498,2589,2676,2757,2832,2900,2961,3015,3062,3103,3139,3170,3198,3224,3249,3273,3299,3325,3354,3386,3419,3455,3493,3531,3569,3607,3643,3676,3705,3730,3750,3763,3771,3773,3769,3759,3745,3726,3703,3678,3650,3621,3592,3561,3531,3501,3471,3440,3410,3378,3346,3312,3276,3238,3197,3154,3109,3060,3010,2958,2904,2850,2795,2741,2687,2633,2581,2530,2479,2430,2380,2330,2279,2227,2172,2114,2052,1987,1918,1844,1766,1685,1600,1513,1425,1336,1248,1162,1078,998,922,851,786,726,672,623,580,540,505,473,443,414,387,360,333,305,277,249,221,192,165,138,113,90,70,53,39,29,22,19,20,24,31,41,53,68,84,102,122,143,165,189,214,242,271,303,337,373,412,453,497,543,590,639,690,740,792,843,894,946,996,1047,1099,1151,1204,1259,1317,1377,1442,1511,1584,1662,1745,1832,1923,2017,2114,2212,2310,2408,2502,2594,2680,2761,2836,2903,2964,3018,3065,3105,3141,3172,3200,3225,3250,3274,3300,3327,3356,3387,3421,3457,3494,3533,3571,3609,3645,3678,3707,3731,3750,3764,3771,3773,3769,3759,3744,3725,3702,3677,3649,3620,3590,3560,3530,3499,3469,3439,3408,3377,3344,3310,3274,3236,3195,3152,3106,3058,3007,2955,2902,2847,2792,2738,2684,2631,2578,2527,2477,2427,2378,2328,2277,2224,2169,2111,2049,1984,1914,1840,1762,1681,1596,1509,1421,1332,1244,1157,1074,994,918,848,783,723,669,621,578,539,503,471,441,413,386,358,331,304,276,248,219,191,163,137,112,89,69,52,38,28,22,19,20,24,31,41,54,69,85,103,123,144,166,190,216,243,273,304,338,375,414,455,499,545,593,642,692,743,794,846,897,948,999,1050,1101,1153,1207,1262,1320,1380,1445,1514,1588,1666,1749,1836,1927,2022,2119,2217,2315,2412,2507,2598,2684,2765,2839,2907,2967,3020,3067,3107,3142,3173,3201,3227,3251,3276,3301,3328,3357,3389,3423,3459,3496,3535,3573,3611,3646,3679,3708,3732,3751,3765,3772,3773,3768,3758,3743,3724,3701,3675,3647,3618,3589,3558,3528,3498,3468,3437,3407,3375,3343,3308,3272,3234,3193,3150,3104,3055,3005,2953,2899,2844,2790,2735,2681,2628,2576,2525,2474,2425,2375,2325,2274,2221,2166,2108,2046,1980,1910,1836,1758,1676,1592,1505,1416,1327,1239,1153,1070,990,914,844,779,720,667,619,575,537,502,470,440,412,384,357,330,302,275,246,218,190,162,135,111,88,68,51,38,28,22,19,20,24,32,42,55,69,86,104,124,145,167,191,217,245,274,306,340,377,416,458,501,547,595,644,695,746,797,848,900,951,1002,1052,1104,1156,1209,1265,1322,1384,1449,1518,1591,1670,1753,1841,1932,2027,2124,2222,2320,2417,2512,2603,2689,2769,2843,2910,2970,3023,3069,3109,3144,3175,3202,3228,3252,3277,3302,3330,3359,3391,3425,3461,3498,3537,3575,3613,3648,3681,3709,3733,3752,3765,3772,3773,3768,3757,3742,3723,3700,3674,3646,3617,3587,3557,3526,3496,3466,3436,3405,3374,3341,3307,3271,3232,3191,3148,3101,3053,3002,2950,2896,2842,2787,2732,2678,2625,2573,2522,2472,2422,2373,2323,2271,2219,2163,2105,2043,1977,1907,1832,1754,1672,1587,1500,1412,1323,1235,1149,1065,986,911,841,776,718,664,616,573,535,500,468,438,410,383,356,329,301,273,245,216,188,161,134,109,87,67,50,37,27,21,19,20,25,32,43,55,70,87,105,125,146,169,193,218,246,276,308,342,379,418,460,504,550,598,647,697,748,799,851,902,953,1004,1055,1106,1158,1212,1267,1325,1387,1452,1521,1595,1674,1757,1845,1937,2032,2129,2227,2325,2422,2516,2607,2693,2773,2846,2913,2972,3025,3071,3111,3146,3176,3204,3229,3254,3278,3304,3331,3360,3392,3426,3462,3500,3539,3577,3615,3650,3682,3711,3734,3753,3765,3772,3773,3767,3757,3741,3722,3698,3673,3645,3615,3586,3555,3525,3495,3465,3434,3404,3372,3339,3305,3269,3230,3189,3145,3099,3050,3000,2947,2894,2839,2784,2730,2676,2623,2571,2520,2469,2420,2370,2320,2269,2216,2160,2102,2040,1973,1903,1829,1750,1668,1583,1496,1407,1319,1231,1145,1061,982,907,838,773,715,662,614,571,533,498,467,437,409,381,354,327,300,272,243,215,187,159,133,108,86,66,50,36,27,21,19,20,25,33,43,56,71,88,106,126,147,170,194,220,248,277,309,344,381,420,462,506,552,600,649,700,751,802,853,905,956,1007,1058,1109,1161,1215,1270,1328,1390,1455,1525,1599,1678,1762,1850,1941,2036,2134,2232,2330,2427,2521,2611,2697,2777,2850,2916,2975,3028,3073,3113,3147,3178,3205,3230,3255,3279,3305,3332,3362,3394,3428,3464,3502,3541,3579,3616,3652,3684,3712,3736,3754,3766,3772,3773,3767,3756,3740,3720,3697,3671,3643,3614,3584,3554,3523,3493,3463,3433,3402,3370,3338,3303,3267,3228,3187,3143,3097,3048,2997,2945,2891,2836,2782,2727,2673,2620,2568,2517,2467,2417,2368,2318,2266,2213,2158,2099,2036,1970,1900,1825,1746,1664,1579,1491,1403,1314,1226,1140,1057,978,904,834,770,712,659,612,569,531,497,465,436,407,380,353,326,298,270,242,214,185,158,132,107,85,65,49,36,27,21,19,20,25,33,44,57,72,89,107,127,148,171,195,221,249,279,311,346,383,422,464,508,554,602,652,702,753,805,856,907,958,1009,1060,1112,1164,1217,1273,1331,1393,1459,1528,1603,1682,1766,1854,1946,2041,2138,2237,2335,2432,2526,2616,2701,2780,2853,2919,2978,3030,3075,3115,3149,3179,3206,3232,3256,3281,3306,3334,3363,3396,3430,3466,3504,3543,3581,3618,3653,3685,3713,3737,3754,3766,3772,3772,3767,3755,3740,3719,3696,3670,3642,3612,3583,3552,3522,3492,3462,3431,3400,3369,3336,3301,3265,3226,3185,3141,3094,3045,2995,2942,2888,2834,2779,2724,2670,2617,2565,2515,2464,2415,2365,2315,2264,2210,2155,2096,2033,1967,1896,1821,1742,1660,1574,1487,1398,1310,1222,1136,1053,974,900,831,767,709,657,610,567,529,495,464,434,406,379,352,324,297,269,241,212,184,157,130,106,84,64,48,35,26,21,19,21,26,34,44,57,73,89,108,128,149,172,196,222,250,280,313,347,384,424,466,510,557,605,654,705,756,807,859,910,961,1012,1063,1114,1166,1220,1276,1334,1396,1462,1532,1607,1686,1770,1859,1951,2046,2143,2242,2340,2436,2530,2620,2705,2784,2857,2922,2981,3032,3077,3117,3151,3181,3208,3233,3257,3282,3308,3335,3365,3397,3432,3468,3506,3544,3583,3620,3655,3687,3715,3738,3755,3767,3773,3772,3766,3755,3739,3718,3695,3668,3640,3611,3581,3551,3520,3490,3460,3430,3399,3367,3334,3300,3263,3224,3183,3139,3092,3043,2992,2939,2885,2831,2776,2722,2668,2615,2563,2512,2462,2412,2363,2312,2261,2208,2152,2093,2030,1963,1892,1817,1738,1655,1570,1483,1394,1305,1218,1132,1049,971,896,828,764,706,654,607,565,528,493,462,433,405,377,350,323,296,267,239,211,183,155,129,105,83,63,47,35,26,21,19,21,26,34,45,58,73,90,109,129,150,173,198,224,252,282,314,349,386,426,468,513,559,607,657,707,758,810,861,912,963,1014,1065,1117,1169,1223,1279,1337,1399,1465,1536,1611,1690,1775,1863,1956,2051,2148,2247,2345,2441,2535,2624,2709,2788,2860,2925,2984,3035,3079,3118,3152,3182,3209,3234,3258,3283,3309,3337,3367,3399,3433,3470,3508,3546,3585,3622,3657,3688,3716,3739,3756,3767,3773,3772,3766,3754,3738,3717,3693,3667,3639,3610,3579,3549,3519,3489,3459,3428,3397,3366,3333,3298,3261,3222,3180,3136,3090,3040,2989,2937,2883,2828,2773,2719,2665,2612,2560,2509,2459,2410,2360,2310,2258,2205,2149,2090,2027,1960,1889,1813,1734,1651,1566,1478,1390,1301,1213,1128,1045,967,893,824,761,704,652,605,563,526,492,461,431,403,376,349,322,294,266,238,209,181,154,128,104,82,63,47,34,25,20,19,21,26,35,46,59,74,91,110,130,151,174,199,225,253,284,316,351,388,428,470,515,562,610,659,710,761,812,864,915,966,1017,1068,1119,1172,1226,1282,1340,1403,1469,1539,1614,1694,1779,1868,1960,2056,2153,2251,2349,2446,2539,2629,2713,2792,2864,2928,2986,3037,3082,3120,3154,3183,15109,15178,15240,15295,15344,15386,15422,15454,15482,15508,15533,15557,15583,15609,15638,15669,15702,15738,15775,15813,15852,15890,15926,15959,15989,16015,16035,16050,16058,16061,16058,16049,16035,16017,15995,15970,15943,15914,15884,15854,15824,15793,15763,15733,15702,15671,15639,15605,15570,15532,15492,15449,15404,15356,15306,15254,15200,15146,15091,15037,14983,14929,14877,14825,14775,14725,14675,14626,14575,14523,14468,14411,14350,14285,14216,14143,14066,13985,13901,13814,13726,13638,13549,13462,13378,13297,13221,13149,13083,13023,12968,12918,12874,12834,12798,12765,12735,12707,12679,12652,12625,12597,12570,12541,12513,12485,12457,12430,12405,12381,12361,12343,12329,12318,12311,12307,12307,12311,12318,12327,12339,12354,12370,12387,12407,12427,12450,12473,12499,12526,12555,12586,12619,12655,12694,12735,12778,12824,12871,12920,12970,13021,13072,13123,13175,13226,13277,13328,13379,13431,13484,13539,13596,13656,13720,13788,13861,13938,14020,14106,14197,14291,14387,14485,14584,14681,14776,14868,14956,15037,15113,15182,15243,15298,15346,15388,15424,15456,15484,15510,15534,15559,15584,15611,15639,15670,15704,15739,15777,15815,15854,15891,15928,15961,15991,16016,16036,16050,16059,16061,16058,16049,16034,16016,15994,15969,15941,15912,15883,15852,15822,15792,15762,15731,15701,15670,15637,15603,15568,15530,15490,15447,15401,15353,15303,15251,15198,15143,15089,15034,14980,14927,14874,14823,14772,14723,14673,14623,14572,14520,14465,14408,14347,14282,14213,14139,14062,13981,13897,13810,13722,13633,13545,13458,13374,13293,13217,13146,13080,13020,12965,12916,12872,12832,12796,12764,12734,12705,12678,12651,12623,12596,12568,12540,12511,12483,12455,12429,12403,12380,12360,12342,12328,12317,12310,12307,12308,12311,12318,12328,12340,12354,12371,12388,12408,12429,12451,12474,12500,12527,12556,12587,12621,12657,12696,12737,12780,12826,12873,12922,12972,13023,13075,13126,13177,13228,13279,13330,13381,13433,13486,13541,13599,13659,13723,13791,13864,13942,14024,14111,14202,14296,14392,14490,14589,14686,14781,14873,14960,15041,15117,15185,15246,15301,15348,15390,15426,15457,15485,15511,15535,15560,15585,15612,15641,15672,15706,15741,15779,15817,15856,15893,15929,15963,15992,16017,16037,16051,16059,16061,16057,16048,16034,16015,15992,15967,15940,15911,15881,15851,15821,15790,15760,15730,15699,15668,15636,15602,15566,15528,15488,15444,15399,15351,15301,15248,15195,15141,15086,15031,14977,14924,14872,14820,14770,14720,14671,14621,14570,14517,14462,14405,14344,14278,14209,14136,14058,13977,13892,13806,13717,13629,13540,13454,13370,13289,13213,13142,13077,13017,12962,12914,12870,12830,12795,12762,12732,12704,12676,12649,12622,12595,12567,12538,12510,12482,12454,12427,12402,12379,12359,12341,12327,12317,12310,12307,12308,12312,12319,12328,12341,12355,12371,12389,12409,12430,12452,12476,12501,12528,12558,12589,12623,12659,12698,12739,12783,12828,12876,12925,12975,13026,13077,13129,13180,13231,13282,13333,13384,13436,13489,13544,13602,13662,13727,13795,13868,13946,14028,14115,14206,14300,14397,14495,14594,14691,14786,14877,14964,15045,15120,15188,15249,15303,15350,15391,15427,15458,15486,15512,15537,15561,15587,15613,15642,15674,15707,15743,15781,15819,15857,15895,15931,15964,15993,16018,16038,16051,16059,16061,16057,16047,16033,16014,15991,15966,15938,15909,15880,15849,15819,15789,15759,15728,15698,15666,15634,15600,15564,15526,15485,15442,15397,15348,15298,15246,15192,15138,15083,15029,14975,14921,14869,14818,14767,14718,14668,14618,14567,14515,14460,14402,14340,14275,14206,14132,14054,13973,13888,13801,13713,13624,13536,13450,13366,13286,13210,13139,13074,13014,12960,12911,12868,12828,12793,12761,12731,12702,12675,12648,12621,12593,12565,12537,12509,12480,12453,12426,12401,12378,12358,12341,12327,12317,12310,12307,12308,12312,12319,12329,12341,12356,12372,12390,12410,12431,12453,12477,12502,12530,12559,12591,12625,12661,12700,12741,12785,12831,12878,12927,12978,13028,13080,13131,13182,13234,13284,13335,13387,13439,13492,13547,13605,13665,13730,13799,13872,13950,14033,14120,14211,14305,14402,14500,14598,14696,14790,14882,14968,15049,15124,15191,15252,15306,15353,15393,15429,15460,15488,15513,15538,15562,15588,15615,15644,15675,15709,15745,15782,15821,15859,15897,15933,15966,15995,16019,16038,16052,16059,16061,16057,16047,16032,16013,15990,15965,15937,15908,15878,15848,15818,15787,15757,15727,15696,15665,15632,15598,15562,15524,15483,15440,15394,15346,15295,15243,15190,15135,15080,15026,14972,14919,14866,14815,14765,14715,14666,14616,14565,14512,14457,14399,14337,14272,14202,14128,14050,13969,13884,13797,13709,13620,13532,13445,13362,13282,13206,13136,13071,13011,12957,12909,12866,12827,12791,12759,12729,12701,12674,12646,12619,12592,12564,12536,12507,12479,12451,12425,12400,12377,12357,12340,12326,12316,12310,12307,12308,12312,12319,12329,12342,12357,12373,12391,12411,12432,12454,12478,12504,12531,12561,12592,12626,12663,12702,12743,12787,12833,12881,12930,12980,13031,13082,13134,13185,13236,13287,13338,13389,13441,13495,13550,13608,13668,13733,13802,13876,13954,14037,14124,14215,14310,14407,14505,14603,14700,14795,14886,14972,15053,15127,15195,15255,15308,15355,15395,15430,15461,15489,15515,15539,15564,15589,15616,15645,15677,15711,15747,15784,15823,15861,15899,15934,15967,15996,16020,16039,16053,16060,16061,16056,16046,16031,16012,15989,15963,15935,15906,15877,15846,15816,15786,15756,15725,15695,15663,15631,15596,15560,15522,15481,15438,15392,15343,15293,15241,15187,15132,15078,15023,14969,14916,14864,14813,14762,14713,14663,14613,14562,14509,14454,14396,14334,14268,14198,14124,14046,13964,13880,13793,13704,13615,13527,13441,13358,13278,13202,13132,13067,13008,12955,12907,12863,12825,12790,12758,12728,12700,12672,12645,12618,12590,12563,12534,12506,12478,12450,12423,12399,12376,12356,12339,12326,12316,12310,12307,12308,12312,12320,12330,12343,12357,12374,12392,12412,12433,12455,12479,12505,12533,12562,12594,12628,12665,12704,12746,12789,12835,12883,12932,12983,13034,13085,13136,13188,13239,13290,13340,13392,13444,13497,13553,13610,13672,13737,13806,13879,13958,14041,14129,14220,14315,14412,14510,14608,14705,14800,14891,14977,15057,15131,15198,15258,15311,15357,15397,15432,15463,15490,15516,15540,15565,15590,15618,15647,15679,15713,15749,15786,15825,15863,15901,15936,15969,15997,16021,16040,16053,16060,16061,16056,16045,16030,16011,15988,15962,15934,15905,15875,15845,15814,15784,15754,15724,15693,15662,15629,15595,15559,15520,15479,15436,15389,15341,15290,15238,15184,15130,15075,15020,14966,14913,14861,14810,14760,14710,14661,14611,14559,14507,14451,14393,14331,14265,14195,14120,14042,13960,13875,13788,13700,13611,13523,13437,13353,13274,13199,13129,13064,13006,12952,12904,12861,12823,12788,12756,12726,12698,12671,12644,12617,12589,12561,12533,12504,12476,12449,12422,12397,12375,12355,12338,12325,12315,12309,12307,12308,12313,12320,12331,12343,12358,12375,12393,12413,12434,12457,12481,12506,12534,12564,12596,12630,12667,12706,12748,12792,12838,12886,12935,12985,13036,13087,13139,13190,13241,13292,13343,13394,13446,13500,13555,13613,13675,13740,13809,13883,13962,14045,14133,14225,14320,14417,14515,14613,14710,14804,14895,14981,15061,15134,15201,15260,15313,15359,15399,15434,15464,15492,15517,15542,15566,15592,15619,15648,15680,15714,15750,15788,15827,15865,15903,15938,15970,15999,16022,16041,16053,16060,16061,16055,16045,16029,16010,15986,15961,15933,15903,15874,15843,15813,15783,15753,15722,15692,15660,15627,15593,15557,15518,15477,15433,15387,15338,15288,15235,15182,15127,15072,15018,14964,14911,14859,14808,14757,14708,14658,14608,14557,14504,14448,14390,14328,14261,14191,14117,14038,13956,13871,13784,13695,13607,13519,13433,13349,13270,13195,13126,13061,13003,12950,12902,12859,12821,12786,12755,12725,12697,12669,12642,12615,12588,12560,12531,12503,12475,12447,12421,12396,12374,12354,12338,12324,12315,12309,12307,12308,12313,12321,12331,12344,12359,12376,12394,12414,12435,12458,12482,12508,12536,12565,12597,12632,12669,12708,12750,12794,12840,12888,12937,12988,13039,13090,13141,13193,13244,13295,13346,13397,13449,13503,13558,13616,13678,13743,13813,13887,13966,14050,14138,14229,14324,14422,14520,14618,14715,14809,14899,14985,15065,15138,15204,15263,15316,15361,15401,15435,15466,15493,15518,15543,15567,15593,15620,15650,15682,15716,15752,15790,15829,15867,15904,15940,15972,16000,16024,16042,16054,16060,16061,16055,16044,16028,16008,15985,15959,15931,15902,15872,15842,15811,15781,15751,15721,15690,15658,15626,15591,15555,15516,15475,15431,15385,15336,15285,15233,15179,15124,15070,15015,14961,14908,14856,14805,14755,14705,14656,14606,14554,14501,14446,14387,14324,14258,14188,14113,14034,13952,13867,13779,13691,13602,13514,13428,13345,13266,13192,13122,13058,13000,12947,12900,12857,12819,12785,12753,12724,12695,12668,12641,12614,12586,12558,12530,12502,12473,12446,12420,12395,12373,12353,12337,12324,12315,12309,12307,12308,12313,12321,12332,12345,12360,12377,12395,12415,12436,12459,12483,12509,12537,12567,12599,12634,12671,12710,12752,12796,12842,12890,12940,12990,13041,13093,13144,13195,13246,13297,13348,13400,13452,13505,13561,13619,13681,13747,13816,13891,13970,14054,14142,14234,14329,14426,14525,14623,14720,14814,14904,14989,15068,15141,15207,15266,15318,15363,15403,15437,15467,15494,15520,15544,15569,15594,15622,15651,15684,15718,15754,15792,15831,15869,15906,15941,15973,16001,16025,16042,16054,16060,16060,16055,16043,16028,16007,15984,15958,15930,15900,15871,15840,15810,15780,15750,15719,15688,15657,15624,15589,15553,15514,15473,15429,15382,15333,15283,15230,15176,15122,15067,15012,14958,14905,14853,14803,14752,14703,14653,14603,14552,14498,14443,14384,14321,14255,14184,14109,14030,13948,13862,13775,13686,13598,13510,13424,13341,13262,13188,13119,13055,12997,12945,12898,12855,12817,12783,12752,12722,12694,12667,12640,12612,12585,12557,12529,12500,12472,12445,12418,12394,12372,12352,12336,12323,12314,12309,12307,12309,12314,12322,12332,12345,12361,12377,12396,12416,12437,12460,12484,12510,12538,12568,12601,12635,12672,12712,12754,12798,12845,12893,12942,12993,13044,13095,13147,13198,13249,13300,13351,13402,13454,13508,13564,13622,13684,13750,13820,13895,13974,14058,14147,14239,14334,14431,14530,14628,14724,14818,14908,14993,15072,15145,15210,15269,15320,15365,15405,15439,15469,15496,15521,15545,15570,15596,15623,15653,15685,15720,15756,15794,15832,15871,15908,15943,15975,16003,16026,16043,16055,16061,16060,16054,16043,16027,16006,15983,15956,15928,15899,15869,15839,15808,15778,15748,15718,15687,15655,15622,15588,15551,15512,15471,15427,15380,15331,15280,15227,15173,15119,15064,15010,14956,14903,14851,14800,14750,14700,14651,14600,14549,14496,14440,14381,14318,14251,14180,14105,14026,13943,13858,13771,13682,13593,13506,13420,13337,13259,13184,13116,13052,12994,12942,12895,12853,12816,12781,12750,12721,12693,12665,12638,12611,12584,12555,12527,12499,12471,12443,12417,12393,12371,12351,12335,12323,12314,12309,12307,12309,12314,12322,12333,12346,12361,12378,12397,12417,12438,12461,12486,12512,12540,12570,12602,12637,12674,12714,12756,12801,12847,12895,12945,12995,13046,13098,13149,13200,13251,13302,13353,13405,13457,13511,13567,13625,13687,13753,13824,13899,13978,14063,14151,14244,14339,14436,14535,14633,14729,14823,14912,14997,15076,15148,15213,15272,15323,15367,15406,15440,15470,15497,15522,15546,15571,15597,15625,15655,15687,15721,15758,15796,15834,15873,15910,15945,15976,16004,16027,16044,16055,16061,16060,16054,16042,16026,16005,15981,15955,15927,15898,15867,15837,15807,15777,15747,15716,15685,15654,15621,15586,15549,15510,15468,15424,15378,15328,15277,15225,15171,15116,15061,15007,14953,14900,14848,14797,14747,14698,14648,14598,14546,14493,14437,14378,14315,14248,14177,14101,14022,13939,13854,13766,13678,13589,13501,13416,13333,13255,13181,13112,13049,12992,12940,12893,12851,12814,12780,12749,12719,12691,12664,12637,12610,12582,12554,12526,12497,12469,12442,12416,12392,12370,12351,12335,12322,12313,12308,12307,12309,12314,12323,12334,12347,12362,12379,12398,12418,12439,12462,12487,12513,12541,12572,12604,12639,12676,12716,12758,12803,12850,12898,12947,12998,13049,13100,13152,13203,13254,13305,13356,13407,13460,13514,13570,13628,13691,13757,13827,13902,13982,14067,14156,14248,14344,14441,14539,14637,14734,14827,14917,15001,15080,15152,15216,15274,15325,15370,15408,15442,15471};
    size_t measures_read = 2048*2;      
    u16_t sample = 0;                   // Generic variable to momently store sample value converted to mV
    // # Loop on measures to convert and save on buffer
    for (u16_t i = 0; i < measures_read; i ++)
    {
        // Get channels offset on buffer
        switch (buf[i] >> 12){
            case ADC_CURRENT_CHANNEL:
                // Realiza a conversão da amostra para tensão de acordo com calibração
                sample = convert_to_voltage(ADC_GET_MEASURE(buf[i]));

                // Salva no buffer de tensão
                buffer_handle = buffer_push(&buf_current, sample);
                break;
            case ADC_VOLTAGE_CHANNEL:
                // Realiza a conversão da amostra para tensão de acordo com calibração
                sample = convert_to_voltage(ADC_GET_MEASURE(buf[i]));
                
                // Salva no buffer de tensão
                buffer_handle = buffer_push(&buf_voltage, sample);
                break; 
            default:
                ESP_LOGE(TAG_SM, "# Unknown channel %d", buf[0]>>12);

        }
    }
    if(buf_voltage.size != buf_current.size){
        ESP_LOGE(TAG_SM, "# Voltage buffer and current doesn't have the same size [%d/%d]", buf_voltage.size, buf_current.size);
    } else {

        // Verifica se os buffers chegaram ao limite
        if(buffers_verify()){
            // # Compute RMS and remove DC offset from signals;
            do_rms(&buf_voltage, &buf_current);
            // # Apply goertzel to voltage signal
            do_ipdft(&buf_voltage, &ip_dft_data);

            
            for(uint16_t x = 0; x < buf_voltage.size ; x++){
                printf("%u,%d;", x, buf_voltage.data[x]);
            }
            printf("\n\n");
            buffer_clean(&buf_voltage);
            // # Apply goertzel to current signal
            do_ipdft(&buf_current, &ip_dft_data);
            buffer_clean(&buf_current);

        }
    }
    vTaskDelete(NULL);
}

void app_main(void)
{


    //setup_wifi();



    // Local variables
	BaseType_t task_create_ret;				// Return of task create
	// Print info to show main task is running
	ESP_LOGI(TAG_SM, "# Running app_main in core %d", xPortGetCoreID());

    /**/
    // Log task creation
	ESP_LOGI(TAG_SM, "# Creating signal_generator task");

	// Create task to generate sine wave
	task_create_ret = xTaskCreatePinnedToCore(
		signal_generator_task,				// Function executed in the task
		"SGT",					            // Task name (for debug)
		4096,								// Stack size in bytes
		NULL,								// Parameter to pass to the function
		1,									// Task priority
		&signal_generator_task_handle,		// Used to pass back a handle by which the created task can be referenced
		1);									// CPU core ID

    // Check task creation error
	if (task_create_ret != pdPASS){ ESP_LOGE(TAG_SM, "Error creating signal_generator task"); }
	// Delay 
	vTaskDelay(10000 / portTICK_PERIOD_MS);
    
    // Log task creation
	ESP_LOGI(TAG_SM, "# Creating sample_read_task");

    
	// Create task to write audio to wav file in SD card
	task_create_ret = xTaskCreatePinnedToCore(
		sample_read_task,					// Function executed in the task
		"SRT",					            // Task name (for debug)
		32000,								// Stack size in bytes
		NULL,								// Parameter to pass to the function
		1,									// Task priority
		&sample_read_task_handle,			// Used to pass back a handle by which the created task can be referenced
		0);									// CPU core ID

    // Check task creation error
	if (task_create_ret != pdPASS){ ESP_LOGE(TAG_SM, "Error creating sample_read task"); }


    
    
}
